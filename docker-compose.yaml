# -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
# docker-compose.yaml
#
# UniFi Timelapse System
# Version 1.0.0 - February 2026
#
# Richard J. Sears
# https://github.com/rjsears/unifi_timelapse
# -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

services:
  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    image: postgres:16-alpine
    container_name: timelapse_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-timelapse}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_DB=${POSTGRES_DB:-timelapse}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -h localhost -U ${POSTGRES_USER:-timelapse} -d ${POSTGRES_DB:-timelapse}']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - timelapse_network

  # ===========================================
  # Redis Cache
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: timelapse_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - timelapse_network

  # ===========================================
  # Timelapse API (FastAPI)
  # ===========================================
  timelapse_api:
    image: rjsears/unifi-timelapse-api:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: timelapse_api
    restart: unless-stopped
    environment:
      # Database
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-timelapse}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-timelapse}
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Security
      - SECRET_KEY=${SECRET_KEY:?SECRET_KEY is required}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:?ADMIN_PASSWORD is required}
      - JWT_EXPIRATION_HOURS=${JWT_EXPIRATION_HOURS:-24}
      # Application
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-America/Los_Angeles}
      # Storage paths (inside container)
      - OUTPUT_BASE_PATH=/output
      - IMAGES_SUBPATH=images
      - VIDEOS_SUBPATH=videos
      # Capture defaults
      - DEFAULT_CAPTURE_INTERVAL=${DEFAULT_CAPTURE_INTERVAL:-30}
      - MAX_CONCURRENT_CAPTURES=${MAX_CONCURRENT_CAPTURES:-50}
      - CAPTURE_TIMEOUT=${CAPTURE_TIMEOUT:-30}
      - CAPTURE_RETRIES=${CAPTURE_RETRIES:-3}
      # Timelapse defaults
      - DEFAULT_FRAME_RATE=${DEFAULT_FRAME_RATE:-30}
      - DEFAULT_CRF=${DEFAULT_CRF:-20}
      - DEFAULT_PIXEL_FORMAT=${DEFAULT_PIXEL_FORMAT:-yuv444p}
      - FFMPEG_TIMEOUT=${FFMPEG_TIMEOUT:-14400}
      - DAILY_TIMELAPSE_TIME=${DAILY_TIMELAPSE_TIME:-01:00}
      # Multi-day defaults
      - MULTIDAY_IMAGES_PER_HOUR=${MULTIDAY_IMAGES_PER_HOUR:-2}
      - MULTIDAY_DAYS_TO_INCLUDE=${MULTIDAY_DAYS_TO_INCLUDE:-7}
      - MULTIDAY_GENERATION_DAY=${MULTIDAY_GENERATION_DAY:-sunday}
      - MULTIDAY_GENERATION_TIME=${MULTIDAY_GENERATION_TIME:-02:00}
      # Cleanup
      - CLEANUP_AFTER_TIMELAPSE=${CLEANUP_AFTER_TIMELAPSE:-true}
      - RETENTION_DAYS_IMAGES=${RETENTION_DAYS_IMAGES:-7}
      - RETENTION_DAYS_VIDEOS=${RETENTION_DAYS_VIDEOS:-365}
      - CLEANUP_TIME=${CLEANUP_TIME:-03:00}
      # Notifications
      - APPRISE_ENABLED=${APPRISE_ENABLED:-false}
      - APPRISE_URL=${APPRISE_URL:-http://apprise:8000}
    volumes:
      - /root/unifi_timelapse/output:/output
      - timelapse_logs:/app/logs
      - timelapse_config:/app/config
    expose:
      - "8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'curl -sf http://localhost:8000/api/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - timelapse_network

  # ===========================================
  # Timelapse Worker (Capture & FFMPEG)
  # ===========================================
  timelapse_worker:
    image: rjsears/unifi-timelapse-worker:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: timelapse_worker
    restart: unless-stopped
    environment:
      # Database
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-timelapse}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-timelapse}
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Application
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-America/Los_Angeles}
      # Storage paths
      - OUTPUT_BASE_PATH=/output
      - IMAGES_SUBPATH=images
      - VIDEOS_SUBPATH=videos
      # Capture settings
      - DEFAULT_CAPTURE_INTERVAL=${DEFAULT_CAPTURE_INTERVAL:-30}
      - MAX_CONCURRENT_CAPTURES=${MAX_CONCURRENT_CAPTURES:-50}
      - CAPTURE_TIMEOUT=${CAPTURE_TIMEOUT:-30}
      - CAPTURE_RETRIES=${CAPTURE_RETRIES:-3}
      # FFMPEG settings
      - DEFAULT_FRAME_RATE=${DEFAULT_FRAME_RATE:-30}
      - DEFAULT_CRF=${DEFAULT_CRF:-20}
      - DEFAULT_PIXEL_FORMAT=${DEFAULT_PIXEL_FORMAT:-yuv444p}
      - FFMPEG_TIMEOUT=${FFMPEG_TIMEOUT:-14400}
      # Schedule settings
      - DAILY_TIMELAPSE_TIME=${DAILY_TIMELAPSE_TIME:-01:00}
      - MULTIDAY_GENERATION_DAY=${MULTIDAY_GENERATION_DAY:-sunday}
      - MULTIDAY_GENERATION_TIME=${MULTIDAY_GENERATION_TIME:-02:00}
      - CLEANUP_TIME=${CLEANUP_TIME:-03:00}
      # Notifications
      - APPRISE_ENABLED=${APPRISE_ENABLED:-false}
      - APPRISE_URL=${APPRISE_URL:-http://apprise:8000}
      - MIN_FAILURES_BEFORE_ALERT=${MIN_FAILURES_BEFORE_ALERT:-3}
    volumes:
      - /root/unifi_timelapse/output:/output
      - timelapse_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      timelapse_api:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'python -c "import sys; sys.exit(0)"']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - timelapse_network

  # ===========================================
  # Camera Health Monitor
  # ===========================================
  timelapse_health:
    image: rjsears/unifi-timelapse-health:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile.health
    container_name: timelapse_health
    restart: unless-stopped
    environment:
      # Database
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-timelapse}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-timelapse}
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Application
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-America/Los_Angeles}
      # Health check settings
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-60}
      - BLANK_CHECK_INTERVAL=${BLANK_CHECK_INTERVAL:-300}
      - FROZEN_CHECK_INTERVAL=${FROZEN_CHECK_INTERVAL:-300}
      - BLANK_THRESHOLD=${BLANK_THRESHOLD:-0.02}
      # Notifications
      - APPRISE_ENABLED=${APPRISE_ENABLED:-false}
      - APPRISE_URL=${APPRISE_URL:-http://apprise:8000}
      - MIN_FAILURES_BEFORE_ALERT=${MIN_FAILURES_BEFORE_ALERT:-3}
      - ALERT_COOLDOWN_MINUTES=${ALERT_COOLDOWN_MINUTES:-30}
    volumes:
      - timelapse_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'python -c "import sys; sys.exit(0)"']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - timelapse_network

  # ===========================================
  # Apprise Notification Service
  # ===========================================
  apprise:
    image: caronc/apprise:latest
    container_name: timelapse_apprise
    restart: unless-stopped
    environment:
      - APPRISE_STATELESS_URLS=${APPRISE_DEFAULT_URLS:-}
    volumes:
      - apprise_config:/config
    expose:
      - "8000"
    healthcheck:
      test: ['CMD-SHELL', 'curl -sf http://localhost:8000/status || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - timelapse_network

  # ===========================================
  # Frontend (Vue.js)
  # ===========================================
  timelapse_frontend:
    image: rjsears/unifi-timelapse-frontend:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: timelapse_frontend
    restart: unless-stopped
    depends_on:
      timelapse_api:
        condition: service_healthy
    expose:
      - "80"
    healthcheck:
      test: ['CMD-SHELL', 'wget --no-verbose --tries=1 --spider http://127.0.0.1:80/ || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - timelapse_network

  # ===========================================
  # Nginx Reverse Proxy
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: timelapse_nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /root/unifi_timelapse/output:/output:ro
    depends_on:
      timelapse_api:
        condition: service_healthy
      timelapse_frontend:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'curl -sf http://localhost/api/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - timelapse_network

# ===========================================
# Volumes
# ===========================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  timelapse_logs:
    driver: local
  timelapse_config:
    driver: local
  apprise_config:
    driver: local

# ===========================================
# Networks
# ===========================================
networks:
  timelapse_network:
    driver: bridge
